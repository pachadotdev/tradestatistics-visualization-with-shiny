## server.R ##

shinyServer(
  function(input, output, session) {
    # Input -------------------------------------------------------------------

    y <- reactive({
      input$y
    })

    r_iso <- reactive({
      input$r
    })

    r_name <- reactive({
      reporters_to_display %>%
        filter(available_reporters_iso == input$r) %>%
        select(available_reporters_names) %>%
        as.character()
    })

    p_iso <- reactive({
      input$p
    })

    p_name <- reactive({
      reporters_to_display %>%
        filter(available_reporters_iso == input$p) %>%
        select(available_reporters_names) %>%
        as.character()
    })

    table_detailed <- reactive({
      if (p_iso() == "all") {
        "yrc"
      } else {
        "yrpc"
      }
    })

    # Data --------------------------------------------------------------------

    data_detailed <- reactive({
      ots_create_tidy_data(
        years = y(),
        reporters = r_iso(),
        partners = p_iso(),
        table = table_detailed(),
        use_localhost = use_localhost
      ) %>% 
        select(community_name, community_color, trade_value_usd_exp) %>%
        filter(trade_value_usd_exp > 0)
    })
    
    r_add_the <- reactive({
      if (substr(r_name(), 1, 6) == "United" | substr(r_name(), 1, 3) == "USA") {
        "the"
      } else {
        ""
      }
    })
    
    p_add_the <- reactive({
      if (substr(p_name(), 1, 6) == "United" | substr(p_name(), 1, 3) == "USA") {
        "the"
      } else {
        ""
      }
    })
    
    exports_title <- reactive({
      switch(
        table_detailed(),
        "yrc" = glue::glue("Exports of { r_add_the() } { r_name() } to the rest of the World in { y() }"),
        "yrpc" = glue::glue("Exports of { r_add_the() } { r_name() } to { p_add_the() } { p_name() } in { y() }")
      )
    })

    exports_treemap_detailed <- reactive({
      d <- data_detailed() %>%
        mutate(
          share = trade_value_usd_exp / sum(trade_value_usd_exp)
          # community_name = ifelse(share < 0.01, "Others <1% each", community_name),
          # community_color = ifelse(share < 0.01, "#d3d3d3", community_color)
        ) %>%
        group_by(community_name, community_color) %>%
        summarise(trade_value_usd_exp = sum(trade_value_usd_exp, na.rm = T)) %>%
        ungroup() %>%
        mutate(
          share = paste0(round(100 * trade_value_usd_exp / sum(trade_value_usd_exp), 2), "%"),
          community_name = paste0(community_name, "<br>", share)
        ) %>%
        rename(
          value = trade_value_usd_exp,
          name = community_name,
          color = community_color
        )
      
      highchart() %>%
        hc_chart(type = "treemap") %>%
        hc_xAxis(categories = d$name) %>%
        hc_add_series(d,
                      name = "Export Value USD",
                      showInLegend = FALSE,
                      dataLabels = list(
                        verticalAlign = "top",
                        align = "left",
                        style = list(fontSize = "12px", textOutline = FALSE)
                      )
        ) %>%
        hc_title(text = exports_title()) %>%
        hc_exporting(enabled = TRUE, buttons = list(contextButton = list(menuItems = hc_export_menu)))
    })

    # Output ------------------------------------------------------------------

    output$exports_treemap_detailed <- renderHighchart({
      exports_treemap_detailed()
    })

    # Bookmarking -------------------------------------------------------------

    observe({
      # Trigger this observer every time an input changes
      # strip shiny related URL parameters
      reactiveValuesToList(input)
      session$doBookmark()
    })

    onBookmarked(function(url) {
      updateQueryString(url)
    })
  }
)
